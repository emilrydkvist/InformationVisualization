<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<link rel="stylesheet" href="style/stylesheet.css" type="text/css"/>
	
	
    
  </head>
  <body>
  <div id="container">
  
    
	
	<button id="clearButton" onclick="animatePaths()">Clear overlays</button>
	<div id="map-canvas"/>
	
	
  </div>
  </body>
  	
  	<script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3Y_z1NJv4bw5RpU0dglIegtfwRJRNaOY&sensor=true">
    </script>

	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="js/readData.js"></script>
  
	<script type="text/javascript">
		google.maps.event.addDomListener(window, 'load', initialize);
			
		var overlays = [];
		var carData = [];
		var map;
		var hourMin = 0;
		var hourMax = 0;
		
		//function to clear all overlays on the map
		//each time an overlay is created it has to be added to the array overlays
		function clearOverlays()
		{
			while(overlays[0])
			{
				overlays.pop().setMap(null);
			}
		}


		function initialize() {
			var self = this;
			
			//Initializing map
			var mapOptions = {
			  center: new google.maps.LatLng(45.450497, 9.187317),
			  zoom: 11
			};
			map = new google.maps.Map(document.getElementById("map-canvas"),
				mapOptions);
				
		}
		
		//creating datareader with delimiter ';'
		var dsv = d3.dsv(";","text/plain");
			
		//reading data from file and storing in carData
		var carData = [];
		dsv("data/Milan_Car_Trajectories.csv", function(data) {
		
			carData = readData(data);

			hourMax = d3.max(data, function(d){return Number(d['hour']);});
			hourMin = d3.min(data, function(d){return Number(d['hour']);});

			drawpaths(carData);
		});
			
		
		
		
		
		function drawpaths(carData)
		{

			var paths = [];
			
			for (var i=1; i<carData.length; i++)
			{
				var trajectory = [];
				
				for(var j=0; j<carData[i].length; j++)
				{
					trajectory.push(new google.maps.LatLng(carData[i][j]['lat'], carData[i][j]['lon']));	
				}
				paths.push(trajectory);
			}
			
			for(var i=0; i<paths.length; i++)
			{
				var path = new google.maps.Polyline({
				  path: paths[i],
				  geodesic: true,
				  strokeColor: '#00F',
				  strokeOpacity: 0.2,
				  strokeWeight: 1,
				});

				//Pathen ritas ut
				path.setMap(map);
				overlays.push(path);
			}
				
		}
		

		function animatePaths(){

			clearOverlays();

			var lineSymbol = {
				path: google.maps.SymbolPath.CIRCLE,
				scale: 2,
				strokeColor: '#000',
				strokeOpacity: 1
			};

			var paths = [];
			
			for (var i=1; i<100; i++)
			{
				var trajectory = [];
				
				for(var j=0; j<carData[i].length; j++)
				{
					trajectory.push(new google.maps.LatLng(carData[i][j]['lat'], carData[i][j]['lon']));	
				}
				paths.push(trajectory);
			}
			
			for(var i=0; i<paths.length; i++)
			{
				var path = new google.maps.Polyline({
				  path: paths[i],
				  icons: [{icon: lineSymbol, offset: '100%'}],
				  geodesic: true,
				  strokeColor: '#00F',
				  strokeOpacity: 0,
				  strokeWeight: 1,
				  map: map,
				});

				//Pathen ritas ut
				//path.setMap(map);
				overlays.push(path);
				animateCircle(path);
			}
			
			function animateCircle(path) {
				var count = 0;
				window.setInterval(function() {
				  count = (count + 1) % 200;

				  var icons = path.get('icons');
				  icons[0].offset = (count / 2) + '%';
				  path.set('icons', icons);
			}, 30);
			}

		}
		
		  
		function loadScript() {
		  var script = document.createElement('script');
		  script.type = 'text/javascript';
		  script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyC3Y_z1NJv4bw5RpU0dglIegtfwRJRNaOY&sensor=false&' +
			  'callback=initialize';
		  document.body.appendChild(script);
		}

		

    </script>
  
</html>